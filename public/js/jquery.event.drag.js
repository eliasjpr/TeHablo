(function(e){e.fn.drag=function(t,n,r){var i=typeof t=="string"?t:"",s=e.isFunction(t)?t:e.isFunction(n)?n:null;if(i.indexOf("drag")!==0)i="drag"+i;r=(t==s?n:r)||{};return s?this.bind(i,r,s):this.trigger(i)};var t=e.event,n=t.special,r=n.drag={defaults:{which:1,distance:0,not:":input",handle:null,relative:false,drop:true,click:false},datakey:"dragdata",livekey:"livedrag",add:function(n){var i=e.data(this,r.datakey),s=n.data||{};i.related+=1;if(!i.live&&n.selector){i.live=true;t.add(this,"draginit."+r.livekey,r.delegate)}e.each(r.defaults,function(e,t){if(s[e]!==undefined)i[e]=s[e]})},remove:function(){e.data(this,r.datakey).related-=1},setup:function(){if(e.data(this,r.datakey))return;var n=e.extend({related:0},r.defaults);e.data(this,r.datakey,n);t.add(this,"mousedown",r.init,n);if(this.attachEvent)this.attachEvent("ondragstart",r.dontstart)},teardown:function(){if(e.data(this,r.datakey).related)return;e.removeData(this,r.datakey);t.remove(this,"mousedown",r.init);t.remove(this,"draginit",r.delegate);r.textselect(true);if(this.detachEvent)this.detachEvent("ondragstart",r.dontstart)},init:function(i){var s=i.data,o;if(s.which>0&&i.which!=s.which)return;if(e(i.target).is(s.not))return;if(s.handle&&!e(i.target).closest(s.handle,i.currentTarget).length)return;s.propagates=1;s.interactions=[r.interaction(this,s)];s.target=i.target;s.pageX=i.pageX;s.pageY=i.pageY;s.dragging=null;o=r.hijack(i,"draginit",s);if(!s.propagates)return;o=r.flatten(o);if(o&&o.length){s.interactions=[];e.each(o,function(){s.interactions.push(r.interaction(this,s))})}s.propagates=s.interactions.length;if(s.drop!==false&&n.drop)n.drop.handler(i,s);r.textselect(false);t.add(document,"mousemove mouseup",r.handler,s);return false},interaction:function(t,n){return{drag:t,callback:new r.callback,droppable:[],offset:e(t)[n.relative?"position":"offset"]()||{top:0,left:0}}},handler:function(e){var i=e.data;switch(e.type){case!i.dragging&&"mousemove":if(Math.pow(e.pageX-i.pageX,2)+Math.pow(e.pageY-i.pageY,2)<Math.pow(i.distance,2))break;e.target=i.target;r.hijack(e,"dragstart",i);if(i.propagates)i.dragging=true;case"mousemove":if(i.dragging){r.hijack(e,"drag",i);if(i.propagates){if(i.drop!==false&&n.drop)n.drop.handler(e,i);break}e.type="mouseup"};case"mouseup":t.remove(document,"mousemove mouseup",r.handler);if(i.dragging){if(i.drop!==false&&n.drop)n.drop.handler(e,i);r.hijack(e,"dragend",i)}r.textselect(true);if(i.click===false&&i.dragging){jQuery.event.triggered=true;setTimeout(function(){jQuery.event.triggered=false},20);i.dragging=false}break}},delegate:function(n){var i=[],s,o=e.data(this,"events")||{};e.each(o.live||[],function(o,u){if(u.preType.indexOf("drag")!==0)return;s=e(n.target).closest(u.selector,n.currentTarget)[0];if(!s)return;t.add(s,u.origType+"."+r.livekey,u.origHandler,u.data);if(e.inArray(s,i)<0)i.push(s)});if(!i.length)return false;return e(i).bind("dragend."+r.livekey,function(){t.remove(this,"."+r.livekey)})},hijack:function(n,i,s,o,u){if(!s)return;var a={event:n.originalEvent,type:n.type},f=i.indexOf("drop")?"drag":"drop",l,c=o||0,h,p,d,v=!isNaN(o)?o:s.interactions.length;n.type=i;n.originalEvent=null;s.results=[];do if(h=s.interactions[c]){if(i!=="dragend"&&h.cancelled)continue;d=r.properties(n,s,h);h.results=[];e(u||h[f]||s.droppable).each(function(o,u){d.target=u;l=u?t.handle.call(u,n,d):null;if(l===false){if(f=="drag"){h.cancelled=true;s.propagates-=1}if(i=="drop"){h[f][o]=null}}else if(i=="dropinit")h.droppable.push(r.element(l)||u);if(i=="dragstart")h.proxy=e(r.element(l)||h.drag)[0];h.results.push(l);delete n.result;if(i!=="dropinit")return l});s.results[c]=r.flatten(h.results);if(i=="dropinit")h.droppable=r.flatten(h.droppable);if(i=="dragstart"&&!h.cancelled)d.update()}while(++c<v);n.type=a.type;n.originalEvent=a.event;return r.flatten(s.results)},properties:function(e,t,n){var i=n.callback;i.drag=n.drag;i.proxy=n.proxy||n.drag;i.startX=t.pageX;i.startY=t.pageY;i.deltaX=e.pageX-t.pageX;i.deltaY=e.pageY-t.pageY;i.originalX=n.offset.left;i.originalY=n.offset.top;i.offsetX=e.pageX-(t.pageX-i.originalX);i.offsetY=e.pageY-(t.pageY-i.originalY);i.drop=r.flatten((n.drop||[]).slice());i.available=r.flatten((n.droppable||[]).slice());return i},element:function(e){if(e&&(e.jquery||e.nodeType==1))return e},flatten:function(t){return e.map(t,function(t){return t&&t.jquery?e.makeArray(t):t&&t.length?r.flatten(t):t})},textselect:function(t){e(document)[t?"unbind":"bind"]("selectstart",r.dontstart).attr("unselectable",t?"off":"on").css("MozUserSelect",t?"":"none")},dontstart:function(){return false},callback:function(){}};r.callback.prototype={update:function(){if(n.drop&&this.available.length)e.each(this.available,function(e){n.drop.locate(this,e)})}};n.draginit=n.dragstart=n.dragend=r})(jQuery)